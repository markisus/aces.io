<head>
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
<link rel="stylesheet" href="{{static_url("css/client.css")}}">
<script src='http://cdn.ractivejs.org/latest/ractive.js'></script>
</head>

<body>
<div id="content" class="content"></div>

<script id='template' type='text/ractive'>
{{!^game}}
Loading
{{!/game}}

{{!#game}}
  <h1 class="title">Game #{{gameid}}</h1>
  <div>
      


	<div class="circle-container">
	    <div class="el table">
	{{!#pot}}
	<span class="chips">
	  ${{!pot}}
	  </span>
	{{!/pot}}

	<!-- Community Cards --><br/>
	{{!#community_cards}}
	<img class="card-large" src="{{!get_card_url(.)}}"/>
	{{!/community_cards}}

	{{!#win_screen}}
	{{!#(win_condition == 'last_man_standing')}}
	{{!this.winner.name}} won {{!this.win_amount}}!
	{{!/win_condition}}
	{{!/win_screen}}
	

	    </div>

      <div class="el actions">
	<!-- Auto action 
	check check-fold call-any
	fold call money, call any
	-->
	<!-- Action 
	fold
	check
	call (all-in)
	raise-to (all-in)
	-->
	<br/>
	{{!#is_my_turn}}
	<button class="pure-button" on-click="fold">fold</button><br/>
	<button class="pure-button pure-button-primary" on-click="call_check">{{!call_check}}</button><br/>
	<button class="pure-button pure-button-primary" on-click="raise_menu">Raise</button>
	{{!/is_my_turn}}
      </div>



	  {{!#seats}}
	  <div class="el seat position{{!((seat_number -  maybe_my_seat_number + 5) + 10)%10}}">

	    {{!#round_bet}}
	<span class="chips">
	  ${{!round_bet}}
	  </span>
	{{!/pot}}

	  <!-- Join/Buy in menu -->
	  {{!#(state == 'empty' && !my_seat)}}
	  {{!#(show_buyin_menu != seat_number)}}
	  <button class="join_button pure-button pure-button-primary" on-click="show_buyin_menu">Join</button>
	  {{!/step1}}
	  {{!#(show_buyin_menu == seat_number)}}
	  <button class="pure-button" on-click="buy_in_increase">+</button>
	  <button class="pure-button" on-click="buy_in_decrease">-</button> <br/>
	  <button class="pure-button pure-button-primary" on-click="buy_in">Buy In for {{!buy_in}}</button>
	  {{!/step2}}
	  {{!/buyin_menu}}
	  <!-- End buy in menu -->

	  <!-- User Display -->
	  {{!#userid}}
	  {{!name}} ${{!money}} <br/>
	  {{!#hole_cards}}
	  <img class="card-large" src="{{!get_card_url(.)}}"/>
	  {{!/hole_cards}}
	  <br/>

	  {{!/userid}}
	  </div>

	  {{!/seats}}
	</div>

  </div>
{{!/game}}
</script>

<script src="{{ static_url("js/client.js")}}"></script>
<script>

  var ractive = new Ractive({
  el: '#content',
  template: '#template',

  data: {
  get_card_url: function(card) {
  if (card == 'unknown') return "{{ static_url('images/cards/blue-back.png') }}";
  var card_array = card.split('.');
  var rank = card_array[0];
  var suit = card_array[1];
  return "{{ static_url('images/cards/') }}" + suit + "/" + rank + ".svg";
  }
  },

  computed: {
  
  seated_userids: function() {
  return this.get('game.seats').map(function(seat){ return seat.userid });
  },

  my_seat: function() {
  var userid = this.get('userid');
  var seated_userids = this.get('seated_userids');
  index = seated_userids.indexOf(userid);
  var seats = this.get('game.seats');
  return seats[index];
  },

  is_my_turn: function() {
  var my_seat = this.get('my_seat');
  var active_user_position = this.get('game.active_user_position');
  var game_state = this.get('game.game_state');
  return my_seat.seat_number == active_user_position && game_state != 'wait_for_players';
  },

  current_bet: function() {
  var seats = this.get('game.seats');
  var round_bets = seats.map(function (seat) {return seat.round_bet});
  return Math.max.apply(null, round_bets);
  },

  call_check: function() {
  var current = this.get('current_bet');
  var my_round_bet = this.get('my_seat').round_bet;
  if (my_round_bet == current) return 'check'
  return 'call ' + (current - my_round_bet);
  },

  maybe_my_seat_number: function() {
  var my_seat = this.get('my_seat');
  if(my_seat) return my_seat.seat_number;
  return 0;
  }

  }

  });



<!-- Action handlers -->
var synchronize_game = function(game) {
ractive.set('game', game);
ractive.set('buy_in_increment', game.min_buy_in/2);
}
var set_userid = function(userid) {
console.log("setting userid", userid);
ractive.set('userid', userid);
}

var receive = function(msg) {
var msg = JSON.parse(msg);
console.log(msg)
var action = msg['action']
if (action == "synchronize_game") synchronize_game(msg.game);
if (action == "set_userid") set_userid(msg.userid);
window.msg = msg
}
var send = connect({{gameid}}, receive);
<!-- end action handlers -->


<!-- Buy in menu -->
ractive.on('show_buyin_menu', function(event) {
ractive.set('show_buyin_menu', event.context.seat_number);
ractive.set('buy_in', ractive.get('game.min_buy_in'))
console.log(event)
});

ractive.on('buy_in_increase', function(event) {
ractive.add('buy_in', ractive.get('buy_in_increment'));
});

ractive.on('buy_in_decrease', function(event) {
var current = ractive.get('buy_in');
var next = current - ractive.get('buy_in_increment');
var result = Math.max(next, ractive.get('game.min_buy_in'));
ractive.set('buy_in', result);
});

<!-- End Buy in menu -->

<!-- Actions -->
ractive.on('buy_in', function(event) {
send({'action':'buy_in', 'buy_in': ractive.get('buy_in'), 'seat_number': event.context.seat_number});
});


ractive.on('fold', function(event) {
send({'action':'fold'});
});

ractive.on('call_check', function(event) {
send({'action':'call'}); 
});


<!-- End Actions -->

</script>

</body>
