<head>
<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
<link rel="stylesheet" href="{{static_url("css/client.css")}}">
<script src='http://cdn.ractivejs.org/latest/ractive.js'></script>
</head>

<body>
<div id="content" class="content"></div>

<script id='template' type='text/ractive'>
{{!^game}}
Loading
{{!/game}}

{{!#game}}
  <h1 class="title">Game #{{gameid}}</h1>
  <div>
	<div class="circle-container">
	    <div class="el table">
	{{!#pot}}
	<span class="chips">
	  ${{!pot}}
	  </span>
	{{!/pot}}

	<!-- Community Cards --><br/>
	{{!#community_cards}}
	<img class="card-large" src="{{!get_card_url(.)}}"/>
	{{!/community_cards}}
	{{!#win_screen}}
	<br/>
	{{!#(win_condition == 'last_man_standing')}}
	{{!this.winner.name}} won {{!this.winnings}}!
	{{!/last_man_standing}}

	{{!#(win_condition == 'showdown')}}
	{{!#winners}}
	{{!winner.name}} won {{!winnings}} with {{!winner.best_hand.type}}
	{{!/winners}}
	{{!/showdown}}

	{{!/win_screen}}
	    </div>

      <div class="el actions">
	<!-- Auto action 
	check check-fold call-any
	fold call money, call any
	-->
	<!-- Action 
	fold
	check
	call (all-in)
	raise-to (all-in)
	-->
	{{!#is_my_turn}}
	{{!^raise_menu}}
	<button class="pure-button" on-click="fold">fold</button>
	<button class="pure-button pure-button-primary" on-click="all_in">all In</button>
	{{!#can_call}}
	<button class="pure-button pure-button-primary" on-click="call_check">{{!call_check}}</button>
	{{!/can_call}}
	{{!#can_raise}}
	<button class="pure-button pure-button-primary" on-click="show_raise_menu">raise</button>
	{{!/can_raise}}
	{{!/hide_raise_menu}}

	<!--  raise menu -->
	{{!#raise_menu}}
	<button class="pure-button" on-click="raise_increase">+</button>
	<button class="pure-button" on-click="raise_decrease">-</button> <button class="pure-button" on-click="hide_raise_menu">x</button><br/>
	<button class="pure-button pure-button-primary" on-click="raise">Raise to {{!current_bet + raise_amount}}</button><br/><br/>
	{{!/raise_menu}}
	{{!/is_my_turn}}
      </div>

	  {{!#seats}}
	  <div class="el seat position{{!((seat_number -  maybe_my_seat_number + 5) + 10)%10}} {{!state}} {{!#(seat_number == active_user_position)}}active{{!/active}}">

	    {{!#round_bet}}
	<span class="chips">
	  ${{!round_bet}}
	  </span>
	{{!/pot}}

	  <!-- Join/Buy in menu -->
	  {{!#(state == 'empty' && !my_seat)}}
	  {{!#(show_buyin_menu != seat_number)}}
	  <button class="join_button pure-button pure-button-primary" on-click="show_buyin_menu">Join</button>
	  {{!/step1}}
	  {{!#(show_buyin_menu == seat_number)}}
	  <button class="pure-button" on-click="buy_in_increase">+</button>
	  <button class="pure-button" on-click="buy_in_decrease">-</button> <br/>
	  <button class="pure-button pure-button-primary" on-click="buy_in">Buy In for {{!buy_in}}</button>
	  {{!/step2}}
	  {{!/buyin_menu}}
	  <!-- End buy in menu -->

	  <!-- User Display -->
	  {{!#userid}}
	  <span class="user">{{!name}} ${{!money}}</span>
	  {{!#hole_cards}}
	  <img class="card-large" src="{{!get_card_url(.)}}"/>
	  {{!/hole_cards}}
	  {{!/userid}}

	  <span class="last_move">
	    {{!last_move}}
	  </span>
	  </div>
	  {{!/seats}}
	</div>

  </div>
{{!/game}}
</script>

<script src="{{ static_url("js/client.js")}}"></script>
<script>

  var ractive = new Ractive({
  el: '#content',
  template: '#template',

  data: {
  get_card_url: function(card) {
  if (card == 'unknown') return "{{ static_url('images/cards/blue-back.png') }}";
  var card_array = card.split('.');
  var rank = card_array[0];
  var suit = card_array[1];
  return "{{ static_url('images/cards/') }}" + suit + "/" + rank + ".svg";
  }
  },

  computed: {
  
  seated_userids: function() {
  return this.get('game.seats').map(function(seat){ return seat.userid });
  },

  my_seat: function() {
  var userid = this.get('userid');
  var seated_userids = this.get('seated_userids');
  index = seated_userids.indexOf(userid);
  var seats = this.get('game.seats');
  return seats[index];
  },

  is_my_turn: function() {
  var my_seat = this.get('my_seat');
  var active_user_position = this.get('game.active_user_position');
  var game_state = this.get('game.game_state');
  return my_seat.seat_number == active_user_position && game_state != 'wait_for_players';
  },

  current_bet: function() {
  var seats = this.get('game.seats');
  var round_bets = seats.map(function (seat) {return seat.round_bet});
  return Math.max.apply(null, round_bets);
  },

  call_check: function() {
  amount_needed_to_call = this.get('amount_needed_to_call');
  if (amount_needed_to_call == 0) return 'check'
  return 'call ' + (amount_needed_to_call);
  },

  amount_needed_to_call: function() {
  var current_bet = this.get('current_bet');
  var my_round_bet = this.get('my_seat').round_bet;
  return current_bet - my_round_bet;
  },

  maybe_my_seat_number: function() {
  var my_seat = this.get('my_seat');
  if(my_seat) return my_seat.seat_number;
  return 0;
  },

  raise_increment: function() {
  var min_raise = this.get('game.min_raise');
  var big_blind = this.get('game.big_blind');
  return Math.max(min_raise, big_blind);
  },

  can_raise: function() {
  var amount_needed_to_call = this.get('amount_needed_to_call');
  var min_raise = this.get('game.min_raise');
  var my_seat = this.get('my_seat');
  return my_seat.money >= amount_needed_to_call + min_raise;
  },

  can_call: function() {
  var amount_needed_to_call = this.get('amount_needed_to_call');
  var my_seat = this.get('my_seat');
  return my_seat.money > amount_needed_to_call;
  }


  }

  });



<!-- Action handlers -->
var synchronize_game = function(game) {
ractive.set('game', game);
ractive.set('buy_in_increment', game.min_buy_in/2);
}
var set_userid = function(userid) {
console.log("setting userid", userid);
ractive.set('userid', userid);
}

var receive = function(msg) {
var msg = JSON.parse(msg);
console.log(msg)
var action = msg['action']
if (action == "synchronize_game") synchronize_game(msg.game);
if (action == "set_userid") set_userid(msg.userid);
window.msg = msg
}
var send = connect({{gameid}}, receive);
<!-- end action handlers -->


<!-- Buy in menu -->
ractive.on('show_buyin_menu', function(event) {
ractive.set('show_buyin_menu', event.context.seat_number);
ractive.set('buy_in', ractive.get('game.min_buy_in'))
console.log(event)
});

ractive.on('buy_in_increase', function(event) {
ractive.add('buy_in', ractive.get('buy_in_increment'));
});

ractive.on('buy_in_decrease', function(event) {
var current = ractive.get('buy_in');
var next = current - ractive.get('buy_in_increment');
var result = Math.max(next, ractive.get('game.min_buy_in'));
ractive.set('buy_in', result);
});

<!-- Raise menu -->
ractive.on('show_raise_menu', function(event) {
ractive.set('raise_menu', true);
ractive.set('raise_amount', ractive.get('game.min_raise'));
});

ractive.on('hide_raise_menu', function (event) {
ractive.set('raise_menu', false);
});

ractive.on('raise_increase', function(event) {
var my_seat = ractive.get('my_seat')
var amount_needed_to_call = ractive.get('amount_needed_to_call');
var next = ractive.get('raise_amount') + ractive.get('raise_increment');
ractive.set('raise_amount', Math.min(my_seat.money - amount_needed_to_call, next));

});

ractive.on('raise_decrease', function(event) {
var current = ractive.get('raise_amount');
var next = current - ractive.get('raise_increment');
var result = Math.max(next, ractive.get('game.min_raise'));
ractive.set('raise_amount', result);
});

ractive.on('hide_raise_menu', function(event) {
ractive.set('raise_menu', false);
});

<!-- Actions -->
ractive.on('buy_in', function(event) {
send({'action':'buy_in', 'buy_in': ractive.get('buy_in'), 'seat_number': event.context.seat_number});
});


ractive.on('fold', function(event) {
send({'action':'fold'});
});

ractive.on('call_check', function(event) {
send({'action':'call'}); 
});

ractive.on('raise', function(event) {
var raise_amount = ractive.get('raise_amount');
send({'action':'raise', 'raise_amount': raise_amount});
});


ractive.on('all_in', function(event) {
send({'action':'all_in'});
});
<!-- End Actions -->

</script>

</body>
